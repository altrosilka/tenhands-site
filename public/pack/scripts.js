(function(){var e,t=[].slice;e=function(){var e,n,r,a,o,s;return a=1<=arguments.length?t.call(arguments,0):[],o=/(^|[\s\n]|<br\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi,a.length>0?(r=a[0],n=function(){var t;t=[];for(e in r)s=r[e],"callback"!==e&&t.push(" "+e+"='"+s+"'");return t}().join(""),this.replace(o,function(e,t,a){var o;return o=("function"==typeof r.callback?r.callback(a):void 0)||"<a href='"+a+"'"+n+">"+a+"</a>",""+t+o})):this.replace(o,"$1<a href='$2'>$2</a>")},String.prototype.autoLink=e}).call(this),function(){function e(e,t){return 1024*(e-55296)+(t-56320)+65536}function t(e){var t=document.createElement("IMG");return t.src="//"+r+a+e+o,t.className="emoji",t}function n(n){var r,a=/([\ud800-\udbff])([\udc00-\udfff])/g,o=n.match(a);return o&&(r=n.replace(a,function(n,r,a){var o=e(r.charCodeAt(0),a.charCodeAt(0)),s=t(o.toString(16));return s.outerHTML}),n=r),n}var r=(parseInt("1f1e6",16),parseInt("1f1ff",16),"assets.github.com"),a="/images/icons/emoji/unicode/",o=".png";String.fromCodePoint||(String.fromCodePoint=function(){var e,t,n,r,a=[];for(r=0;r<arguments.length;++r)e=arguments[r],t=e-65536,n=e>65535?[55296+(t>>10),56320+(1023&t)]:[e],a.push(String.fromCharCode.apply(null,n));return a.join("")}),window.emojiParseInText=n}(this);var App=angular.module("Cabinet",["configuraion","ui.router","ngSanitize","ui.bootstrap","cabinet.templates","S_eventer","S_selfapi","S_vk","S_utils","S_location","complexGroupChart","extendedWallPost","ngEnter","vkEmoji","datePickers","parseVkUrls","C_main","C_cabinet","CCV_index","CCV_groups","CCV_admin_groups.page","CCV_search","CCV_groups.page"]);App.config(["$stateProvider","$urlRouterProvider","$locationProvider","$httpProvider",function(e,t,n,r){r.defaults.useXDomain=!0,delete r.defaults.headers.common["X-Requested-With"],n.html5Mode(!0).hashPrefix("!"),t.otherwise("/"),e.state("index",{url:"/",controller:"CCV_index as ctr",templateUrl:"cabinet/views/index.html"}).state("admin_groups",{url:"/admin/groups/",controller:"CCV_admin_groups as ctr",templateUrl:"cabinet/views/admin/groups/index.html"}).state("admin_groups_page",{url:"/admin/groups/:id/",controller:"CCV_admin_groups.page as ctr",templateUrl:"cabinet/views/admin/groups/page.html"}).state("groups",{url:"/groups/",controller:"CCV_groups as ctr",templateUrl:"cabinet/views/groups/index.html"}).state("groups_page",{url:"/groups/:id/?from&to",controller:"CCV_groups.page as ctr",templateUrl:"cabinet/views/groups/page.html"}).state("search",{url:"/search/",controller:"CCV_search as ctr",templateUrl:"cabinet/views/search/index.html"})}]),angular.module("configuraion",[]).constant("__vkAppId",4637584).constant("__timezone",6).constant("__api",{baseUrl:"http://api.smm.dev/",paths:{getVkToken:"user/getVkToken",addGroup:"admin/addGroup",loadAdminGroups:"admin/loadGroups",addSecretToGroup:"admin/addSecretToGroup",sendCode:"admin/sendCode"}}),App.run(["S_vk",function(){}]),angular.module("C_cabinet",[]).controller("C_cabinet",["$scope","S_selfapi","S_vk",function(e,t,n){var r=this;return t.getVkToken().then(function(e){n.setToken(e.data.token),n.testRequest().then(function(){console.log(1)},function(){console.log(2)})}),r}]),angular.module("C_main",[]).controller("C_main",["$scope",function(){var e=this;return e}]),angular.module("complexGroupChart",[]).controller("CD_complexGroupChart",["$q","$filter","S_vk","__vkAppId","__timezone",function(e,t,n,r,a){var o=this;return o.getDataForChart=function(o,s,i){var u=e.defer(),d="yyyy-MM-dd";return n.request("stats.get",{group_id:i,app_id:r,date_from:t("date")(o,d,a),date_to:t("date")(s,d,a)}).then(function(e){var t,n=e.response,r={views:{name:"Посещения",data:[],color:"#F90"},visitors:{name:"Визиты",data:[],color:"#a60"},subscribed:{name:"Подписки",data:[],color:"#36638E"},unsubscribed:{name:"Отписки",data:[],color:"#B05C91"}};_.forEach(n.reverse(),function(e){t=1e3*+moment(e.day,"YYYY-MM-DD").format("X")+36e5*a,r.views.data.push([t,+e.views]),r.visitors.data.push([t,+e.visitors]),r.subscribed.data.push([t,+e.subscribed]),r.unsubscribed.data.push([t,+e.unsubscribed])}),u.resolve(r)}),u.promise},o}]).directive("complexGroupChart",[function(){return{scope:{startDate:"=",endDate:"=",groupId:"="},controller:"CD_complexGroupChart",templateUrl:"cabinet/directives/complexGroupChart.html",link:function(e,t,n,r){function a(){"undefined"!=typeof e.startDate&&"undefined"!=typeof e.endDate&&"undefined"!=typeof e.groupId&&r.getDataForChart(e.startDate,e.endDate,e.groupId).then(function(e){var n=_.map(e,function(e){return e}),r={chart:{},title:{text:""},subtitle:{text:""},plotOptions:{line:{marker:{enabled:!0,radius:5,symbol:"circle"},lineWidth:2}},tooltip:{shared:!0,backgroundColor:"#fff",formatter:function(){},useHTML:!0,borderColor:"transparent",backgroundColor:"transparent",borderRadius:0,shadow:!1},legend:{enabled:!0}};angular.extend(r,{xAxis:{tickmarkPlacement:"on",type:"datetime",dateTimeLabelFormats:{day:"%d.%m",week:"%d.%m",month:"%B",year:"%Y"},minTickInterval:864e5,tickPixelInterval:40,labels:{}},yAxis:{min:0,title:{text:"Temperature (°C)"},plotLines:[{value:0,width:1,color:"#808080"}]},series:n}),t.highcharts(r).find('text:contains("Highcharts.com")').remove()})}e.$watch("startDate",a),e.$watch("endDate",a),e.$watch("groupId",a)}}}]),angular.module("datePickers",[]).directive("dateInterval",["$filter","_timezone",function(e,t){return{scope:{start:"=",end:"=",format:"="},templateUrl:"cabinet/directives/dateInterval.html",link:function(n){var r=n.format||"dd.MM.yyyy";n.$watch(function(){return n.start},function(){n.filteredStart=e("date")(n.start,r,t)}),n.$watch(function(){return n.end},function(){n.filteredEnd=e("date")(n.end,r,t)})}}}]).directive("selectDate",["$filter",function(e){return{scope:{isOpen:"=",hideInputs:"=",minDate:"=",maxDate:"=",model:"="},templateUrl:"cabinet/directives/selectDate.html",link:function(t,n){function r(t,n){n&&(t.editdate.day=e("date")(n,"dd",0),t.editdate.month=e("date")(n,"MM",0),t.editdate.year=e("date")(n,"yyyy",0))}t.editdate={day:void 0,month:void 0,year:void 0},t.$watch("model",function(e){r(t,e)}),n.find(".inputs input").on("blur",function(){if("undefined"!=typeof t.editdate.day&&"undefined"!=typeof t.editdate.month&&"undefined"!=typeof t.editdate.year){var e=new Date(parseInt(t.editdate.year),parseInt(t.editdate.month)-1,parseInt(t.editdate.day));t.$apply(isNaN(e)?function(){r(t,t.model)}:function(){t.model=e,r(t,e)})}}).on("keypress",function(e){13==e.which&&$(this).trigger("blur")})}}}]),angular.module("extendedWallPost",[]).directive("extendedWallPost",["$timeout",function(e){return{link:{post:function(t,n){e(function(){var e,t=n.find(".text"),r=parseInt(n.find(".text").css("line-height")),a=t.height(),o=Math.floor(a/r);if(a>10*r){t.height(10*r),n.addClass("big");var s=o-10;n.attr("data-lines",s),e=$(document.createElement("div")).addClass("more").html("еще "+s+" строк").insertAfter(t).on("click",function(){n.toggleClass("extended"),n.hasClass("extended")?(e.html("скрыть"),t.height(a)):($("html, body").animate({scrollTop:"-="+s*r+"px"},0),e.html("еще "+s+" строк"),t.height(10*r))})}},0)}}}}]),angular.module("ngEnter",[]).directive("ngEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.ngEnter)}),t.preventDefault())})}}),angular.module("vkEmoji",[]).directive("vkEmoji",[function(){return{link:function(){}}}]),angular.module("parseVkUrls",[]).filter("parseVkUrls",[function(){return function(e,t){if(e){for(var n=/\[club([0-9]*)\|([^\]]*)\]/g,r=/\[id([0-9]*)\|([^\]]*)\]/g,a=[],o=0;o<e.length;++o)a.push(e.charCodeAt(o));e=emojiParseInText(e);var s=e.autoLink();return s=t?s.replace(n,"<span>$2</span>"):s.replace(n,'<a class="link" href="/public/$1/">$2</a>'),s=s.replace(r,"<span>$2</span>").replace(/\n/g,"<br />")}}}]),angular.module("S_eventer",[]).service("S_eventer",["$rootScope",function(e){var t={};return t.sendEvent=function(t,n){e.$broadcast(t,n)},t}]),angular.module("S_location",[]).service("S_location",["$location",function(e){var t;return t={setAttr:function(t,n){var r={};r[t]=n,e.search(angular.extend(e.$$search,r))},setDay:function(t){t="string"==typeof t?t:moment(t).format("YYYYMMDD"),e.search(angular.extend(e.$$search,{day:t}))},setFromTo:function(t,n){t="string"==typeof t?t:moment(t).format("YYYYMMDD"),n="string"==typeof n?n:moment(n).format("YYYYMMDD"),e.search(angular.extend(e.$$search,{from:t,to:n}))},setBranch:function(t){t=t[0],e.search(angular.extend(e.$$search,{branch:t.id}))},setBranches:function(t){var n=_.map(t,function(e){return e.id}).join("-");""===n&&(n=void 0),e.search(angular.extend(e.$$search,{branch:n}))},getAnalyticTimeIntervals:function(){return analyticTimeIntervals}}}]),angular.module("S_mapping",[]).service("S_mapping",[function(){var e={};return e}]),angular.module("S_selfapi",[]).service("S_selfapi",["$http","__api",function(e,t){var n={},r=t.baseUrl;return n.getVkToken=function(){return e({url:r+t.paths.getVkToken,method:"GET"})},n.addGroup=function(n){return e({url:r+t.paths.addGroup,method:"POST",data:{group_id:n}})},n.addSecretToGroup=function(n,a,o){return e({url:r+t.paths.addSecretToGroup,method:"POST",data:{group_id:n,appId:a,secret:o}})},n.sendApplicationCode=function(n,a){return e({url:r+t.paths.sendCode,method:"POST",data:{code:n,hash:a}})},n.loadAdminGroups=function(n){return e({url:r+t.paths.loadAdminGroups,method:"GET",data:{group_id:n}})},n}]),angular.module("S_utils",[]).service("S_utils",["$modal",function(e){var t={};return t.openAddGroupDialog=function(){return e.open({templateUrl:"cabinet/modals/addGroup.html",controller:"CCM_addGroup as ctr",size:"md"}).result},t}]),angular.module("S_vk",[]).service("S_vk",["$q","$http","S_utils",function(e,t){var n={};n.default={version:"5.26",language:"ru"};var r=[];return n.request=function(r,a,o){var s=e.defer();return n.getToken().then(function(e){var i="/method/"+r+"?access_token="+e;a.v=a.v||n.default.version,a.lang=a.lang||n.default.language;for(var u in a)"message"===u?i+="&"+u+"="+encodeURIComponent(a[u]):"object"==typeof a[u]&&a[u].length?_.forEach(a[u],function(e){i+="&"+u+"[]="+e}):i+="&"+u+"="+a[u];t.jsonp("https://api.vk.com"+i,{params:{callback:"JSON_CALLBACK"}}).then(function(e){"function"==typeof o?o(e.data):s.resolve(e.data)})}),s.promise},n.setToken=function(e){n.token=e,r.length>0&&angular.forEach(r,function(t){t.resolve(e)})},n.testRequest=function(){var t=e.defer();return n.request("users.get",{},function(e){e.response?t.resolve():t.reject()}),t.promise},n.getToken=function(){var t=e.defer();return n.token?t.resolve(n.token):r.push(t),t.promise},n}]),angular.module("CCV_index",[]).controller("CCV_index",["$scope",function(){var e=this;return e}]),angular.module("Cabinet").controller("CCM_addGroup",["$scope","$modalInstance","S_vk","S_selfapi",function(e,t,n,r){var a=this;return a.url="",a.resolveAndAdd=function(){return a.error="",""===a.url?void(a.error="пустой запрос"):void n.request("utils.resolveScreenName",{screen_name:a.url.split("/").pop()}).then(function(e){if(_.isObject(e.response)){if("group"!==e.response.type)return void(a.error="это не похоже на ссылку группы");r.addGroup(e.response.object_id).then(function(e){return e.data.error?("enemy"===e.data.error_code&&(a.error="звезды сказали, что ты не являешься создателем этой группы"),void("already"===e.data.error_code&&(a.error="группа уже добавлена"))):void(e.data.success&&t.close(!0))})}else a.error="это какая-то неправильная ссылка"})},a}]),angular.module("CCV_groups",[]).controller("CCV_groups",["$scope","S_vk","S_selfapi",function(e,t){var n=this;return n.setOrder=function(e){n.paramOrdering!==e?(n.reverseOrdering=!0,n.paramOrdering=e):n.reverseOrdering=!n.reverseOrdering},t.request("groups.get",{extended:1,filter:"admin,editor",fields:"members_count"}).then(function(e){n.groups=e.response.items,n.timeStatus=moment().format("HH:mm / DD.MM.YYYY"),t.request("execute.getGroupsListInfo",{groupsArray:_.map(n.groups,function(e){return"-"+e.id})}).then(function(e){console.log(e);var t;_.forEach(e.response,function(e){t=_.find(n.groups,function(t){return Math.abs(e.id)==t.id}),t&&(t.lastPostUnix=e.last_posts.length?e.last_posts[0].date:0,t.lastPostHuman=t.lastPostUnix?moment(t.lastPostUnix,"X").fromNow():"еще не было")})})}),n}]),angular.module("CCV_groups.page",[]).controller("CCV_groups.page",["$scope","$state","S_vk","S_selfapi","S_location","__vkAppId",function(e,t,n,r,a){function o(){s.endDate=t.params.to?moment(t.params.to,"YYYYMMDD").toDate():moment().toDate(),s.startDate=t.params.from?moment(t.params.from,"YYYYMMDD").toDate():moment(s.endDate).add(-6,"days").toDate()}var s=this;s.today=new Date,s.isOpen={start:!1,end:!1},e.$watch(function(){return s.startDate&&s.endDate?s.startDate.toString()+s.endDate.toString():void 0},function(e){e&&a.setFromTo(s.startDate,s.endDate)}),s.openCalendar=function(e,t){t.preventDefault(),t.stopPropagation(),"start"===e?s.isOpen.start=!s.isOpen.start:s.isOpen.end=!s.isOpen.end};var i=t.params.id;return n.request("groups.getById",{group_id:i,fields:"city,country,place,description,wiki_page,members_count,counters,start_date,finish_date,can_post,can_see_all_posts,activity,status,contacts,links,fixed_post,site"}).then(function(e){e.response?(s.info=e.response[0],console.log(s.info)):alert("Какой-то неверный ID группы. Или что-то сломалось... Попробуйте обновить страницу")}),e.$on("$stateChangeSuccess",function(e,t){o(t.name)}),o(),s}]),angular.module("CCV_search",[]).controller("CCV_search",["$scope","S_vk","S_selfapi",function(e,t){function n(e){var t=[],n=(e.profiles,e.groups);return console.log(e),_.forEach(e.items,function(e){if(!(e.copy_history||e.from_id>0)){var r=Math.abs(e.source_id||e.owner_id),a=_.find(n,function(e){return e.id===r});t.push({date:e.date,dateHuman:moment(e.date,"X").format("HH:mm / DD.MM.YYYY"),post_id:e.post_id,text:e.text,comments:e.comments.count,reposts:e.reposts.count,likes:e.likes.count,attachments:e.attachments,owner_id:a.id,owner_photo:a.photo_100,owner_name:a.name,owner_screen_name:a.screen_name,owner_members:a.members_count,strange:e.likes.count?(e.reposts.count/e.likes.count*100).toFixed(2):0,total:a.members_count?(e.likes.count/a.members_count*100).toFixed(2):0})}}),t}var r=this;return r.today=new Date,r.isOpen={start:!1,end:!1},r.posts=[],r.resetQuery=function(){delete r.query,r.query="-46281060,-7089825"},r.openCalendar=function(e,t){t.preventDefault(),t.stopPropagation(),"start"===e?r.isOpen.start=!r.isOpen.start:r.isOpen.end=!r.isOpen.end},t.request("wall.getById",{posts:"-46281060_1239",extended:1}).then(function(e){r.posts=n(e.response)}),r.search=function(){var e=r.query;if(r.posts.length=0,e&&""!==e&&" "!==e&&r.searchType)switch(r.searchType){case"word":var a={return_banned:1,q:e,extended:1,fields:"members_count"};r.startDate&&(a.start_time=moment(r.startDate).format("X")),r.endDate&&(a.end_time=moment(r.endDate).format("X")),t.request("newsfeed.search",a).then(function(e){r.posts=n(e.response)});break;case"list":var a={filters:"post",return_banned:1,source_ids:e,fields:"members_count"};r.startDate&&(a.start_time=moment(r.startDate).format("X")),r.endDate&&(a.end_time=moment(r.endDate).format("X")),t.request("newsfeed.get",a).then(function(e){r.posts=n(e.response)})}},r}]),angular.module("Cabinet").controller("CCV_admin_groups",["$scope","S_vk","S_selfapi","S_utils",function(e,t,n,r){var a=this;return a.addGroup=function(){r.openAddGroupDialog().then(function(){a.loadGroups()})},a.loadGroups=function(){n.loadAdminGroups().then(function(e){a.groups=e.data.groups})},a.loadGroups(),a}]),angular.module("CCV_admin_groups.page",[]).controller("CCV_admin_groups.page",["$scope","$state","S_vk","S_selfapi","S_location","__vkAppId",function(e,t,n,r){var a=this;a.appId="4631997",a.secret="9tIzZR8WHBqtEzw8KskJ";var o=t.params.id;return a.authApp=function(){var e=a.appId,t=a.secret;r.addSecretToGroup(o,e,t).then(function(t){t.data.success&&(window.open("https://oauth.vk.com/authorize?client_id="+e+"&redirect_uri=http://oauth.vk.com/blank.html&response_type=code&v=5.9&scope=groups,photos,friends,video,audio,wall,offline,email,docs,stats","_blank"),a.hash=t.data.hash)})},a.sendCode=function(){var e=a.code,t=a.hash;r.sendApplicationCode(e,t).then(function(e){e.data.success&&alert("Все получилось!")})},a}]);